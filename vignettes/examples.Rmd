---
title: "modCathRes: Examples"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{examples}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: inline
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(modelCathRes)
library(dplyr, quietly = T, warn.conflicts = F)
```

# Get test data

```{r plotCathodeResistance, include=TRUE}
data("resCathData")
d <- resCathData
# reduce number of pots 
d <- d %>% 
  filter(cod_cuve %in% sample(unique(d$cod_cuve), 20))
head(d)
```

# Log model for cathode resistance for all data

Formula: $a + b.log(x)$

```{r lmModel, include=TRUE, fig.dim=c(8, 6)}
funLog <- modelCathRes::findLogFunction(d, agebsq, rucv)
# log fit curve
curve <-  ggplot2::stat_function(xlim = c(min(d$agebsq),
                                  max(d$agebsq)),
                         fun = funLog,
                         color = "darkred",
                         size = 1.2) 
ggplot2::ggplot(d, ggplot2::aes(x = agebsq, y = rucv)) +
  ggplot2::geom_point(shape = 21, fill = NA, size = .9, alpha = .5) +
  ggplot2::coord_cartesian(ylim = c(.4, 1.0)) +
  curve
```

# View cathode resistance and model for each pot

Same model $a + b.log(age)$ for all pots.

```{r plotCathRes, include=TRUE, fig.dim=c(8, 12)}
modelCathRes::plotCathRes(d, cod_cuve, agebsq, rucv, ncol = 4) +
  ggplot2::labs(title = "Evolution of Cathode Resistance per pot") +
  ggplot2::coord_cartesian(ylim = c(.5, 1.0)) +
  curve
```

# Comparing cathode resistance between groups 

## lm model

Using lm with log(age) function for age dependence and 0 intercept. Estimate in table is intitial value of cathode resistance.

```{r compGroups, include=TRUE}
modelCathoRes1(d, group, agebsq, rucv)
```

# lmer model 

Each group has own log coefficient and intercept.

```{r lme4_1, eval=FALSE}
# lmer model from lme4with formula rucv ~ 1  + (1 + log(agebsq) | group))
(modLmer <- modelCathoRes2(d, cod_cuve, agebsq, rucv))
# Coefficients for each group
coef(modLmer)
# Adding predictions to data
d <- modelr::add_predictions(d, model = modLmer)
# Graph of cathode resistance with age for 
```

